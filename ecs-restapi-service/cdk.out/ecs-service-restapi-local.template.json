{
 "Description": "ECS service for RESTful API with ALB",
 "Resources": {
  "ecssecuritygroupfromecsservicerestapilocalalbsgrestapi12C6F93809C4BD96C": {
   "Type": "AWS::EC2::SecurityGroupIngress",
   "Properties": {
    "IpProtocol": "tcp",
    "Description": "Allows all from ALB",
    "FromPort": 0,
    "GroupId": "sg-09b87df3d3fe1ddbe",
    "SourceSecurityGroupId": {
     "Fn::GetAtt": [
      "albsgrestapiF15AB258",
      "GroupId"
     ]
    },
    "ToPort": 0
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/ecs-security-group/from ecsservicerestapilocalalbsgrestapi12C6F938:0"
   }
  },
  "ecssecuritygroupfromecsservicerestapilocalalbsgrestapi12C6F9383276865535BB1311BE": {
   "Type": "AWS::EC2::SecurityGroupIngress",
   "Properties": {
    "IpProtocol": "tcp",
    "Description": "Load balancer to target",
    "FromPort": 32768,
    "GroupId": "sg-09b87df3d3fe1ddbe",
    "SourceSecurityGroupId": {
     "Fn::GetAtt": [
      "albsgrestapiF15AB258",
      "GroupId"
     ]
    },
    "ToPort": 65535
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/ecs-security-group/from ecsservicerestapilocalalbsgrestapi12C6F938:32768-65535"
   }
  },
  "taskexecutionrolePolicy68CA3FD9": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ecr:BatchCheckLayerAvailability",
        "ecr:GetDownloadUrlForLayer",
        "ecr:BatchGetImage"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          "arn:",
          {
           "Ref": "AWS::Partition"
          },
          ":ecr:ap-northeast-2:681747700094:repository/cdk-hnb659fds-container-assets-681747700094-ap-northeast-2"
         ]
        ]
       }
      },
      {
       "Action": "ecr:GetAuthorizationToken",
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "taskexecutionrolePolicy68CA3FD9",
    "Roles": [
     {
      "Fn::Select": [
       1,
       {
        "Fn::Split": [
         "/",
         {
          "Fn::Select": [
           5,
           {
            "Fn::Split": [
             ":",
             "arn:aws:iam::681747700094:role/AmazonECSTaskExecutionRole"
            ]
           }
          ]
         }
        ]
       }
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/task-execution-role/Policy/Resource"
   }
  },
  "taskrolePolicyFA6CED8E": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ssmmessages:CreateControlChannel",
        "ssmmessages:CreateDataChannel",
        "ssmmessages:OpenControlChannel",
        "ssmmessages:OpenDataChannel"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": "logs:DescribeLogGroups",
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "logs:CreateLogStream",
        "logs:DescribeLogStreams",
        "logs:PutLogEvents"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "taskrolePolicyFA6CED8E",
    "Roles": [
     {
      "Fn::Select": [
       1,
       {
        "Fn::Split": [
         "/",
         {
          "Fn::Select": [
           5,
           {
            "Fn::Split": [
             ":",
             "arn:aws:iam::681747700094:role/ECSDefaultTaskRole"
            ]
           }
          ]
         }
        ]
       }
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/task-role/Policy/Resource"
   }
  },
  "taskdefinitionBBCB03E6": {
   "Type": "AWS::ECS::TaskDefinition",
   "Properties": {
    "ContainerDefinitions": [
     {
      "Cpu": 1024,
      "Essential": true,
      "Image": {
       "Fn::Sub": "681747700094.dkr.ecr.ap-northeast-2.${AWS::URLSuffix}/cdk-hnb659fds-container-assets-681747700094-ap-northeast-2:26bce4fce16da84613508f32988b8dc2617f5a97efbe6d31dbfb84c971538228"
      },
      "MemoryReservation": 1024,
      "Name": "restapi-container",
      "PortMappings": [
       {
        "ContainerPort": 8080,
        "HostPort": 0,
        "Protocol": "tcp"
       }
      ]
     }
    ],
    "ExecutionRoleArn": "arn:aws:iam::681747700094:role/AmazonECSTaskExecutionRole",
    "Family": "restapi-task",
    "NetworkMode": "bridge",
    "RequiresCompatibilities": [
     "EC2"
    ],
    "TaskRoleArn": "arn:aws:iam::681747700094:role/ECSDefaultTaskRole"
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/task-definition/Resource"
   }
  },
  "ec2serviceServiceCAD2C483": {
   "Type": "AWS::ECS::Service",
   "Properties": {
    "CapacityProviderStrategy": [
     {
      "CapacityProvider": "AsgCapacityProvider",
      "Weight": 1
     }
    ],
    "Cluster": "cdk-ecs-ec2-local",
    "DeploymentConfiguration": {
     "MaximumPercent": 200,
     "MinimumHealthyPercent": 50
    },
    "EnableECSManagedTags": false,
    "EnableExecuteCommand": true,
    "LoadBalancers": [
     {
      "ContainerName": "restapi-container",
      "ContainerPort": 8080,
      "TargetGroupArn": {
       "Ref": "albhttpslistenerec2servicetargetGroup679226C2"
      }
     }
    ],
    "SchedulingStrategy": "REPLICA",
    "ServiceName": "restapi",
    "TaskDefinition": {
     "Ref": "taskdefinitionBBCB03E6"
    }
   },
   "DependsOn": [
    "albhttpslistenerec2servicetargetGroup679226C2",
    "albhttpslistener38FF2581"
   ],
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/ec2-service/Service"
   }
  },
  "ec2serviceTaskCountTargetC1D8A82F": {
   "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
   "Properties": {
    "MaxCapacity": 20,
    "MinCapacity": 2,
    "ResourceId": {
     "Fn::Join": [
      "",
      [
       "service/cdk-ecs-ec2-local/",
       {
        "Fn::GetAtt": [
         "ec2serviceServiceCAD2C483",
         "Name"
        ]
       }
      ]
     ]
    },
    "RoleARN": {
     "Fn::Join": [
      "",
      [
       "arn:",
       {
        "Ref": "AWS::Partition"
       },
       ":iam::681747700094:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ]
     ]
    },
    "ScalableDimension": "ecs:service:DesiredCount",
    "ServiceNamespace": "ecs"
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/ec2-service/TaskCount/Target/Resource"
   }
  },
  "ec2serviceTaskCountTargetcpuscaling88567D68": {
   "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
   "Properties": {
    "PolicyName": "ecsservicerestapilocalec2serviceTaskCountTargetcpuscaling0D1C16B8",
    "PolicyType": "TargetTrackingScaling",
    "ScalingTargetId": {
     "Ref": "ec2serviceTaskCountTargetC1D8A82F"
    },
    "TargetTrackingScalingPolicyConfiguration": {
     "PredefinedMetricSpecification": {
      "PredefinedMetricType": "ECSServiceAverageCPUUtilization"
     },
     "ScaleInCooldown": 120,
     "ScaleOutCooldown": 60,
     "TargetValue": 50
    }
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/ec2-service/TaskCount/Target/cpuscaling/Resource"
   }
  },
  "loggroup98B39ABC": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "restapi",
    "RetentionInDays": 14
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/loggroup/Resource"
   }
  },
  "albsgrestapiF15AB258": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "ALB security group, service: restapi",
    "GroupName": "albsg-restapi",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "VpcId": "vpc-0d905c34a572c439d"
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/albsg-restapi/Resource"
   }
  },
  "alb8A8B13C2": {
   "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
   "Properties": {
    "LoadBalancerAttributes": [
     {
      "Key": "deletion_protection.enabled",
      "Value": "false"
     },
     {
      "Key": "idle_timeout.timeout_seconds",
      "Value": "30"
     }
    ],
    "Name": "alb-restapi",
    "Scheme": "internet-facing",
    "SecurityGroups": [
     {
      "Fn::GetAtt": [
       "albsgrestapiF15AB258",
       "GroupId"
      ]
     }
    ],
    "Subnets": [
     "subnet-0aeef7a9cf0485c04",
     "subnet-02c777ae0ad6d8ff5",
     "subnet-006cefa6196444072"
    ],
    "Type": "application"
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/alb/Resource"
   }
  },
  "albhttpslistener38FF2581": {
   "Type": "AWS::ElasticLoadBalancingV2::Listener",
   "Properties": {
    "DefaultActions": [
     {
      "TargetGroupArn": {
       "Ref": "albhttpslistenerec2servicetargetGroup679226C2"
      },
      "Type": "forward"
     }
    ],
    "LoadBalancerArn": {
     "Ref": "alb8A8B13C2"
    },
    "Port": 80,
    "Protocol": "HTTP"
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/alb/https-listener/Resource"
   }
  },
  "albhttpslistenerec2servicetargetGroup679226C2": {
   "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
   "Properties": {
    "HealthCheckIntervalSeconds": 12,
    "HealthCheckPath": "/ping",
    "HealthCheckTimeoutSeconds": 10,
    "HealthyThresholdCount": 2,
    "Name": "tg-restapi",
    "Port": 8080,
    "Protocol": "HTTP",
    "TargetGroupAttributes": [
     {
      "Key": "deregistration_delay.timeout_seconds",
      "Value": "15"
     },
     {
      "Key": "stickiness.enabled",
      "Value": "false"
     }
    ],
    "TargetType": "instance",
    "UnhealthyThresholdCount": 5,
    "VpcId": "vpc-0d905c34a572c439d"
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/alb/https-listener/ec2-service-targetGroup/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/11STW/CMAz9LbuHbFTb7nxpQkLaRLmjEExkGpIqTplQ1f8+pxlQOMV5z/Z7tlzI4kO+vahfGul9NbK4k20Zla7EGsg3QYNgbtuCLmQ7O7gSdBMwXr6Cb+qlMwGIxAMonrM6geok2x9vUV8Sm6NOgCbZbhRVczigw4jeJfoZ8S4qdBAG2EIXJYQzsrteLYelVlbtLKQGM9+4mCTCVhFBJDn3uoKwPCkDk4QkTq6h9oTRh8tUEY9a12xNJQ3VRE/cEJ3hjdw6B8OVSfMRyc8m8OK4oMx194kfgE5Yb3jylTe3hV1jdmwVRdTWq/2OJZzmujPvfnK3tmJu2nMQcvHgP8xDiuD+c67xgM+mbx4G364T/Y74EgzrJ/a7iXXTj349jE44vwd5pNfz+FOO3/mMjoQ4Crx5PIFc5/cPRbeyH2ICAAA="
   },
   "Metadata": {
    "aws:cdk:path": "ecs-service-restapi-local/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "VPC": {
   "Value": "vpc-0d905c34a572c439d"
  },
  "Cluster": {
   "Value": "cdk-ecs-ec2-local"
  },
  "Service": {
   "Value": {
    "Ref": "ec2serviceServiceCAD2C483"
   }
  },
  "TaskDefinition": {
   "Value": "restapi-task"
  },
  "LogGroup": {
   "Value": {
    "Ref": "loggroup98B39ABC"
   }
  },
  "ALB": {
   "Value": {
    "Fn::GetAtt": [
     "alb8A8B13C2",
     "DNSName"
    ]
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}